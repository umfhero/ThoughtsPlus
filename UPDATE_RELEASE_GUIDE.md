# Calendar Plus - Auto-Update Release Guide

## Overview

Calendar Plus V5 now includes an automatic update system that allows users to update with one click directly from the Settings page. This guide explains how to publish releases that work with the auto-updater.

## How Auto-Updates Work

1. **On Startup**: The app silently checks GitHub for new releases
2. **In Settings**: Users can manually check for updates anytime
3. **Download**: Users click "Download Update" when available
4. **Install**: Users click "Install & Restart" to complete the update
5. **Clean Transition**: NSIS installer overwrites the old version, updates the startup registry entry automatically

## Publishing a New Release

### Step 1: Update Version Number

Update the version in `package.json`:

```json
{
  "version": "5.1.0" // Change this
}
```

**Note**: You only need to update `package.json`. The installer files will be generated with the correct version automatically.

### Step 2: Build the Application

Run the build command:

```powershell
npm run build
```

This will:

- Compile TypeScript files
- Build the React frontend
- Package the Electron app
- Create the NSIS installer in the `release/` folder
- Generate `latest.yml` (required for auto-updates)

### Step 3: Create a GitHub Release

1. Go to: https://github.com/umfhero/CalendarPlus/releases
2. Click "Draft a new release"
3. **Tag version**: `v5.1.0` (must start with 'v')
4. **Release title**: `Calendar Plus v5.1.0`
5. **Description**: Add release notes (new features, bug fixes, etc.)
6. **Attach files**:
   - Upload the installer from `release/` folder (e.g., `Calendar Plus Setup 5.0.0.exe`)
   - Upload `release/latest.yml` (critical for auto-updater!)
7. Click "Publish release"

### Step 4: Verify Auto-Update Works

1. Install the current version on a test machine
2. Publish the new release on GitHub
3. Open the app, go to Settings
4. Click "Check for Updates"
5. Verify it detects the new version
6. Click "Download Update"
7. Click "Install & Restart"
8. Confirm the new version opens correctly

## Important Notes

### Version Numbering

- Always use semantic versioning: `MAJOR.MINOR.PATCH`
- Git tags must start with 'v' (e.g., `v5.1.0`)
- The app compares versions automatically

### Required Files in GitHub Release

- ✅ **Installer exe**: `Calendar Plus Setup X.X.X.exe`
- ✅ **latest.yml**: Auto-generated by electron-builder (contains version and file checksums)

### User Data Safety

- All user data is stored in `Documents/CalendarPlus` or `OneDrive/CalendarPlus`
- Updates **DO NOT** affect user data
- Settings, events, drawings, and notes are preserved
- The installer only replaces app files in `%LOCALAPPDATA%\Calendar Plus`

### Startup Behavior

- The NSIS installer updates the registry entry: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run\CalendarPlus`
- This automatically points to the new executable path
- Only one version will run on startup (no duplicates)
- The `app.setLoginItemSettings()` in main.ts uses `app.getPath('exe')` which always resolves to the current version

### Code Signing

- Currently **not code signed** (would cost $200-400/year for certificate)
- Windows SmartScreen may show a warning on first install
- This does **not** affect auto-updates once installed
- If you want to add signing later, update the `win.sign` property in `package.json`

## Troubleshooting

### Users Don't See Updates

- Verify `latest.yml` was uploaded to the GitHub release
- Check the GitHub release tag starts with 'v'
- Ensure the release is published (not a draft)

### Update Download Fails

- Check your internet connection
- Verify GitHub release assets are public
- Check the console for error messages

### Update Won't Install

- Ensure the app has write permissions to `%LOCALAPPDATA%\Calendar Plus`
- Try running as administrator
- Check Windows Defender isn't blocking the installer

## Development vs Production

### Development

- Auto-updater is disabled when running via `npm run dev`
- Use `npm run build` to test the full update flow

### Production

- Auto-updater only works in packaged builds
- Always test updates on a separate machine before releasing to users

## Future Enhancements

Potential improvements for future versions:

- [ ] Add auto-download option (currently user must click "Download")
- [ ] Add update notifications/toasts
- [ ] Add release notes viewer in the app
- [ ] Add rollback mechanism
- [ ] Add code signing for better Windows integration

## Support

If users encounter update issues:

1. Check the GitHub releases page: https://github.com/umfhero/CalendarPlus/releases
2. Download and run the latest installer manually
3. User data will be preserved during manual installation
